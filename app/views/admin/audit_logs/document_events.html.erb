<%# app/views/admin/audit_logs/document_events.html.erb %>
<%
  sort_params = params.permit(:status, :event_type, :governing_body_id, :start_date, :end_date, :sort, :direction).to_h
  current_sort = params[:sort]
  current_direction = params[:direction] || "desc"
%>
<div class="space-y-6">
  <%= render "shared/page_header",
             title: "Audit Logs",
             subtitle: "System activity, authentication, and document events" %>

  <%= render "admin/audit_logs/tabs", current_tab: :documents %>

  <%# Section Header with count badge %>
  <div class="flex items-center justify-between">
    <h2 class="text-xl font-bold">Document Events</h2>
    <div class="badge badge-lg badge-ghost font-semibold">
      <%= icon("document", size: "w-4 h-4") %>
      <span class="ml-1"><%= pluralize(@pagy.count, "event") %></span>
    </div>
  </div>

  <%# Filters %>
  <div class="card bg-base-100 border border-base-200 shadow-sm">
    <div class="card-body p-4">
      <div class="flex flex-wrap items-center gap-4">
        <%# Status filter pills %>
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-sm font-medium text-base-content/70">Status:</span>
          <%= doc_event_filter_pills(current_filter: params[:status], filter_counts: @filter_counts) %>
        </div>
      </div>

      <%# Additional filters row %>
      <div class="flex flex-wrap items-center gap-4 mt-3 pt-3 border-t border-base-200">
        <%# Event type dropdown %>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-base-content/70">Event:</span>
          <select class="select select-bordered select-sm" onchange="window.location.href = this.value">
            <option value="<%= admin_document_events_path(sort_params.except(:event_type)) %>"
                    <%= 'selected' if params[:event_type].blank? %>>
              All Events
            </option>
            <% @event_types.each do |event_type| %>
              <option value="<%= admin_document_events_path(sort_params.merge(event_type: event_type)) %>"
                      <%= 'selected' if params[:event_type] == event_type %>>
                <%= event_type.humanize %>
              </option>
            <% end %>
          </select>
        </div>

        <%# Governing body dropdown %>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-base-content/70">Board:</span>
          <select class="select select-bordered select-sm" onchange="window.location.href = this.value">
            <option value="<%= admin_document_events_path(sort_params.except(:governing_body_id)) %>"
                    <%= 'selected' if params[:governing_body_id].blank? %>>
              All Boards
            </option>
            <% @governing_bodies.each do |body| %>
              <option value="<%= admin_document_events_path(sort_params.merge(governing_body_id: body.id)) %>"
                      <%= 'selected' if params[:governing_body_id].to_s == body.id.to_s %>>
                <%= body.name %>
              </option>
            <% end %>
          </select>
        </div>
      </div>

      <%# Date range filter %>
      <div class="mt-3 pt-3 border-t border-base-200">
        <%= render "admin/audit_logs/date_range_filter",
                   path_helper: :admin_document_events_path,
                   current_params: params.permit(:status, :event_type, :governing_body_id, :start_date, :end_date, :sort, :direction) %>
      </div>
    </div>
  </div>

  <%# Logs Table %>
  <div class="card bg-base-100 border border-base-200 shadow-sm">
    <div class="card-body p-0">
      <% if @logs.any? %>
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr class="bg-base-200/50">
                <th class="font-semibold">
                  <%= sortable_column(column: :created_at, label: "Timestamp", current_sort: current_sort, current_direction: current_direction, path_helper: :admin_document_events_path, preserved_params: sort_params) %>
                </th>
                <th class="font-semibold">
                  <%= sortable_column(column: :event_type, label: "Event", current_sort: current_sort, current_direction: current_direction, path_helper: :admin_document_events_path, preserved_params: sort_params) %>
                </th>
                <th class="font-semibold">
                  <%= sortable_column(column: :document, label: "Document", current_sort: current_sort, current_direction: current_direction, path_helper: :admin_document_events_path, preserved_params: sort_params) %>
                </th>
                <th class="font-semibold">
                  <%= sortable_column(column: :governing_body, label: "Board", current_sort: current_sort, current_direction: current_direction, path_helper: :admin_document_events_path, preserved_params: sort_params) %>
                </th>
                <th class="font-semibold w-20"></th>
              </tr>
            </thead>
            <tbody>
              <% @logs.each do |log| %>
                <tr class="hover:bg-base-50 <%= doc_event_border_class(log) %>">
                  <td class="whitespace-nowrap">
                    <div class="text-sm font-medium"><%= log.created_at.strftime("%b %d, %Y") %></div>
                    <div class="text-xs text-base-content/50"><%= log.created_at.strftime("%I:%M:%S %p") %></div>
                  </td>
                  <td>
                    <%= doc_event_badge(log) %>
                  </td>
                  <td>
                    <% if log.document %>
                      <% if log.document.governing_body&.town %>
                        <%= link_to town_document_path(log.document.governing_body.town, log.document),
                                    class: "link link-hover text-sm" do %>
                          <%= truncate(log.document.source_file_name, length: 40) %>
                        <% end %>
                      <% else %>
                        <span class="text-sm"><%= truncate(log.document.source_file_name, length: 40) %></span>
                      <% end %>
                    <% else %>
                      <span class="text-sm text-base-content/50">Document #<%= log.document_id %> (deleted)</span>
                    <% end %>
                  </td>
                  <td>
                    <% if log.document&.governing_body %>
                      <%= link_to log.document.governing_body.name,
                                  admin_document_events_path(sort_params.merge(governing_body_id: log.document.governing_body_id)),
                                  class: "link link-hover text-sm" %>
                    <% else %>
                      <span class="text-base-content/50">â€”</span>
                    <% end %>
                  </td>
                  <td>
                    <% if log.metadata_parsed&.any? %>
                      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('details-<%= log.id %>').showModal()">
                        <%= icon("eye", size: "w-4 h-4") %>
                      </button>
                      <%= render "admin/audit_logs/details_modal",
                                 modal_id: "details-#{log.id}",
                                 title: "Event Metadata",
                                 sections: [
                                   { label: "Metadata", content: log.metadata_parsed, type: :key_value }
                                 ] %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="p-4 border-t border-base-200">
          <%= render "shared/pagination", pagy: @pagy, url_builder: ->(page) { admin_document_events_path(sort_params.merge(page: page)) } %>
        </div>
      <% else %>
        <div class="p-8">
          <%= render "shared/empty_state",
                     icon_name: "document",
                     title: "No Document Events Found",
                     description: "Document events will appear here as documents are processed. Try adjusting your filters." %>
        </div>
      <% end %>
    </div>
  </div>
</div>
