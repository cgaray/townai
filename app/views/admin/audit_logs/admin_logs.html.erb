<%# app/views/admin/audit_logs/admin_logs.html.erb %>
<%
  sort_params = params.permit(:action_type, :user_id, :start_date, :end_date, :sort, :direction).to_h
  current_sort = params[:sort]
  current_direction = params[:direction] || "desc"
%>
<div class="space-y-6">
  <%= render "shared/page_header",
             title: "Audit Logs",
             subtitle: "System activity, authentication, and document events" %>

  <%= render "admin/audit_logs/tabs", current_tab: :admin %>

  <%# Section Header with count badge %>
  <div class="flex items-center justify-between">
    <h2 class="text-xl font-bold">Admin Actions</h2>
    <div class="badge badge-lg badge-ghost font-semibold">
      <%= icon("clipboard-document-list", size: "w-4 h-4") %>
      <span class="ml-1"><%= pluralize(@pagy.count, "action") %></span>
    </div>
  </div>

  <%# Filters %>
  <div class="card bg-base-100 border border-base-200 shadow-sm">
    <div class="card-body p-4">
      <div class="flex flex-wrap items-center gap-4">
        <%# Category filter pills %>
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-sm font-medium text-base-content/70">Category:</span>
          <%= admin_log_filter_pills(current_filter: params[:action_type], filter_counts: @filter_counts) %>
        </div>

        <%# User filter dropdown %>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-base-content/70">User:</span>
          <select class="select select-bordered select-sm" onchange="window.location.href = this.value">
            <option value="<%= admin_admin_logs_path(sort_params.except(:user_id)) %>"
                    <%= 'selected' if params[:user_id].blank? %>>
              All Users
            </option>
            <% User.order(:email).each do |user| %>
              <option value="<%= admin_admin_logs_path(sort_params.merge(user_id: user.id)) %>"
                      <%= 'selected' if params[:user_id].to_s == user.id.to_s %>>
                <%= user.email %>
              </option>
            <% end %>
          </select>
        </div>
      </div>

      <%# Date range filter %>
      <div class="mt-3 pt-3 border-t border-base-200">
        <%= render "admin/audit_logs/date_range_filter",
                   path_helper: :admin_admin_logs_path,
                   current_params: params.permit(:action_type, :user_id, :start_date, :end_date, :sort, :direction) %>
      </div>
    </div>
  </div>

  <%# Logs Table %>
  <div class="card bg-base-100 border border-base-200 shadow-sm">
    <div class="card-body p-0">
      <% if @logs.any? %>
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr class="bg-base-200/50">
                <th class="font-semibold">
                  <%= sortable_column(column: :created_at, label: "Timestamp", current_sort: current_sort, current_direction: current_direction, path_helper: :admin_admin_logs_path, preserved_params: sort_params) %>
                </th>
                <th class="font-semibold">
                  <%= sortable_column(column: :user, label: "User", current_sort: current_sort, current_direction: current_direction, path_helper: :admin_admin_logs_path, preserved_params: sort_params) %>
                </th>
                <th class="font-semibold">
                  <%= sortable_column(column: :action, label: "Action", current_sort: current_sort, current_direction: current_direction, path_helper: :admin_admin_logs_path, preserved_params: sort_params) %>
                </th>
                <th class="font-semibold">
                  <%= sortable_column(column: :resource_type, label: "Resource", current_sort: current_sort, current_direction: current_direction, path_helper: :admin_admin_logs_path, preserved_params: sort_params) %>
                </th>
                <th class="font-semibold">IP Address</th>
                <th class="font-semibold w-20"></th>
              </tr>
            </thead>
            <tbody>
              <% @logs.each do |log| %>
                <tr class="hover:bg-base-50 <%= admin_action_border_class(log.action) %>">
                  <td class="whitespace-nowrap">
                    <div class="text-sm font-medium"><%= log.created_at.strftime("%b %d, %Y") %></div>
                    <div class="text-xs text-base-content/50"><%= log.created_at.strftime("%I:%M:%S %p") %></div>
                  </td>
                  <td>
                    <%= link_to log.user.email, 
                                admin_admin_logs_path(sort_params.merge(user_id: log.user_id)),
                                class: "link link-hover text-sm" %>
                  </td>
                  <td>
                    <%= admin_action_badge(log.action) %>
                  </td>
                  <td>
                    <%= render "admin/audit_logs/resource_link", log: log %>
                  </td>
                  <td class="font-mono text-xs text-base-content/50"><%= log.ip_address %></td>
                  <td>
                    <% if log.previous_state.present? || log.new_state.present? || log.params.present? %>
                      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('details-<%= log.id %>').showModal()">
                        <%= icon("eye", size: "w-4 h-4") %>
                      </button>
                      <%= render "admin/audit_logs/details_modal",
                                 modal_id: "details-#{log.id}",
                                 title: "Action Details",
                                 sections: [
                                   { label: "Previous State", content: log.previous_state, type: :json },
                                   { label: "New State", content: log.new_state, type: :json },
                                   { label: "Parameters", content: log.params, type: :json }
                                 ] %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="p-4 border-t border-base-200">
          <%= render "shared/pagination", pagy: @pagy, url_builder: ->(page) { admin_admin_logs_path(sort_params.merge(page: page)) } %>
        </div>
      <% else %>
        <div class="p-8">
          <%= render "shared/empty_state",
                     icon_name: "clipboard-document-list",
                     title: "No Admin Actions Found",
                     description: "Admin actions will appear here as users make changes. Try adjusting your filters." %>
        </div>
      <% end %>
    </div>
  </div>
</div>
