<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Townai" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Townai">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%# Google Fonts - Inter for bold, modern typography %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="min-h-screen bg-base-100 accent-bar-top">
    <% if defined?(current_town) && current_town.present? %>
      <%# Town-scoped layout with sidebar %>
      <div class="drawer lg:drawer-open">
        <input id="sidebar-drawer" type="checkbox" class="drawer-toggle" />

        <%# Main content area %>
        <div class="drawer-content flex flex-col">
          <%# Navbar with gradient accent %>
          <nav class="navbar bg-base-100 border-b border-base-300 sticky top-0 z-30 shadow-sm">
            <div class="flex-none lg:hidden">
              <label for="sidebar-drawer" class="btn btn-square btn-ghost">
                <%= icon("bars-3", size: "w-6 h-6") %>
              </label>
            </div>
            <div class="flex-1">
              <%= link_to town_path(current_town), class: "flex items-center gap-2 hover:opacity-80 transition-opacity" do %>
                <span class="icon-circle icon-circle-sm icon-circle-brand">
                  <%= icon("building-library", size: "w-4 h-4") %>
                </span>
                <span class="text-xl font-extrabold tracking-tight text-gradient-primary"><%= current_town.name %></span>
              <% end %>
            </div>
            <div class="flex-none gap-2 flex items-center">
              <%# Search trigger button %>
              <button type="button" 
                      onclick="document.getElementById('search-modal').showModal()"
                      class="btn btn-ghost btn-sm gap-2 text-base-content/60 hover:text-base-content">
                <%= icon("magnifying-glass", size: "w-4 h-4") %>
                <span class="hidden sm:inline">Search</span>
                <kbd class="kbd kbd-sm hidden sm:inline-flex" data-hotkey-modifier>Ctrl</kbd>
                <kbd class="kbd kbd-sm hidden sm:inline-flex">K</kbd>
              </button>

              <%# User dropdown %>
              <% if user_signed_in? %>
                <div class="dropdown dropdown-end">
                  <div tabindex="0" role="button" class="btn btn-ghost btn-sm gap-2">
                    <%= avatar(current_user.email, size: :sm) %>
                    <span class="hidden md:inline text-sm font-medium"><%= current_user.email.split("@").first %></span>
                    <%= icon("chevron-down", size: "w-4 h-4") %>
                  </div>
                  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-50 w-56 p-2 shadow-lg border border-base-200 mt-2">
                    <li class="menu-title">
                      <span class="text-xs text-base-content/50"><%= current_user.email %></span>
                    </li>
                    <% if current_user.admin? %>
                      <li class="menu-title">
                        <span class="text-xs text-base-content/50">Admin</span>
                      </li>
                      <li>
                        <%= link_to admin_users_path, class: "flex items-center gap-2" do %>
                          <%= icon("users", size: "w-4 h-4") %>
                          Users
                        <% end %>
                      </li>
                      <li>
                        <%= link_to admin_api_costs_path, class: "flex items-center gap-2" do %>
                          <%= icon("currency-dollar", size: "w-4 h-4") %>
                          API Costs
                        <% end %>
                      </li>
                      <li class="divider"></li>
                    <% end %>
                    <li>
                      <%= button_to destroy_user_session_path, method: :delete, class: "flex items-center gap-2 text-error" do %>
                        <%= icon("arrow-right-start-on-rectangle", size: "w-4 h-4") %>
                        Sign Out
                      <% end %>
                    </li>
                  </ul>
                </div>
              <% end %>
            </div>
          </nav>

          <%# Page content %>
          <main class="flex-1 p-4 md:p-6 lg:p-8">
            <div class="max-w-6xl mx-auto animate-slide-up">
              <%= yield %>
            </div>
          </main>
        </div>

        <%# Sidebar %>
        <aside class="drawer-side z-40">
          <label for="sidebar-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
          <div class="sidebar-gradient min-h-full w-64 p-4 border-r border-base-300">
            <%# Sidebar header with town name %>
            <div class="flex items-center gap-3 px-2 py-4 mb-6">
              <span class="icon-circle icon-circle-lg icon-circle-brand shadow-md">
                <%= icon("building-library", size: "w-6 h-6") %>
              </span>
              <div>
                <div class="font-extrabold text-lg tracking-tight text-gradient-primary"><%= current_town.name %></div>
                <div class="text-xs text-base-content/50">Town Meeting Manager</div>
              </div>
            </div>

            <%# Navigation section %>
            <div class="mb-6">
              <div class="text-xs font-semibold text-base-content/40 uppercase tracking-wider px-3 mb-2">
                Navigation
              </div>
              <ul class="space-y-1">
                <li>
                  <%= link_to town_documents_path(current_town), class: "flex items-center gap-3 px-3 py-2.5 rounded-lg menu-item-hover font-medium #{controller_name == 'documents' ? 'bg-primary/10 text-primary' : 'text-base-content/70 hover:text-base-content'}" do %>
                    <%= icon("document-text", size: "w-5 h-5") %>
                    <span>Documents</span>
                    <span class="ml-auto badge badge-sm badge-ghost"><%= town_stats[:documents_count] %></span>
                  <% end %>
                </li>
                <li>
                  <%= link_to town_governing_bodies_path(current_town), class: "flex items-center gap-3 px-3 py-2.5 rounded-lg menu-item-hover font-medium #{controller_name == 'governing_bodies' ? 'bg-primary/10 text-primary' : 'text-base-content/70 hover:text-base-content'}" do %>
                    <%= icon("building-library", size: "w-5 h-5") %>
                    <span>Governing Bodies</span>
                    <span class="ml-auto badge badge-sm badge-ghost"><%= town_stats[:governing_bodies_count] %></span>
                  <% end %>
                </li>
                <li>
                  <%= link_to town_people_path(current_town), class: "flex items-center gap-3 px-3 py-2.5 rounded-lg menu-item-hover font-medium #{controller_name == 'people' ? 'bg-primary/10 text-primary' : 'text-base-content/70 hover:text-base-content'}" do %>
                    <%= icon("users", size: "w-5 h-5") %>
                    <span>People</span>
                    <span class="ml-auto badge badge-sm badge-ghost"><%= town_stats[:people_count] %></span>
                  <% end %>
                </li>
                <li>
                  <%= link_to town_topics_path(current_town), class: "flex items-center gap-3 px-3 py-2.5 rounded-lg menu-item-hover font-medium #{controller_name == 'topics' ? 'bg-primary/10 text-primary' : 'text-base-content/70 hover:text-base-content'}" do %>
                    <%= icon("list-bullet", size: "w-5 h-5") %>
                    <span>Actions</span>
                    <span class="ml-auto badge badge-sm badge-ghost"><%= town_stats[:topics_count] || 0 %></span>
                  <% end %>
                </li>
              </ul>
            </div>

            <%# Quick stats section %>
            <div class="mb-6">
              <div class="text-xs font-semibold text-base-content/40 uppercase tracking-wider px-3 mb-2">
                Quick Stats
              </div>
              <div class="space-y-2 px-3">
                <div class="stat-card flex items-center justify-between">
                  <span class="text-sm text-base-content/60">Complete</span>
                  <span class="font-semibold text-success"><%= town_stats[:complete_count] %></span>
                </div>
                <div class="stat-card flex items-center justify-between">
                  <span class="text-sm text-base-content/60">Processing</span>
                  <span class="font-semibold text-warning"><%= town_stats[:processing_count] %></span>
                </div>
              </div>
            </div>

            <%# Switch town link %>
            <div class="mb-6">
              <%= link_to towns_path, class: "flex items-center gap-2 px-3 py-2 text-sm text-base-content/60 hover:text-primary transition-colors" do %>
                <%= icon("chevron-left", size: "w-4 h-4") %>
                <span>Switch Town</span>
              <% end %>
            </div>

            <%# Sidebar footer %>
            <div class="absolute bottom-4 left-4 right-4">
              <div class="text-xs text-base-content/40 text-center font-medium">
                v1.0.0
              </div>
            </div>
          </div>
        </aside>
      </div>

      <%# Search modal %>
      <%= render "shared/search_modal" %>
    <% else %>
      <%# Simple layout for towns index (no sidebar) %>
      <nav class="navbar bg-base-100 border-b border-base-300 sticky top-0 z-30 shadow-sm">
        <div class="flex-1 justify-center">
          <%= link_to root_path, class: "flex items-center gap-2 hover:opacity-80 transition-opacity" do %>
            <span class="icon-circle icon-circle-sm icon-circle-brand">
              <%= icon("building-library", size: "w-4 h-4") %>
            </span>
            <span class="text-xl font-extrabold tracking-tight text-gradient-primary">TownAI</span>
          <% end %>
        </div>
        <div class="flex-none gap-2 flex items-center">
          <%# User dropdown %>
          <% if user_signed_in? %>
            <div class="dropdown dropdown-end">
              <div tabindex="0" role="button" class="btn btn-ghost btn-sm gap-2">
                <%= avatar(current_user.email, size: :sm) %>
                <span class="hidden md:inline text-sm font-medium"><%= current_user.email.split("@").first %></span>
                <%= icon("chevron-down", size: "w-4 h-4") %>
              </div>
              <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-50 w-56 p-2 shadow-lg border border-base-200 mt-2">
                <li class="menu-title">
                  <span class="text-xs text-base-content/50"><%= current_user.email %></span>
                </li>
                <% if current_user.admin? %>
                  <li class="menu-title">
                    <span class="text-xs text-base-content/50">Admin</span>
                  </li>
                  <li>
                    <%= link_to admin_users_path, class: "flex items-center gap-2" do %>
                      <%= icon("users", size: "w-4 h-4") %>
                      Users
                    <% end %>
                  </li>
                  <li>
                    <%= link_to admin_api_costs_path, class: "flex items-center gap-2" do %>
                      <%= icon("currency-dollar", size: "w-4 h-4") %>
                      API Costs
                    <% end %>
                  </li>
                  <li class="divider"></li>
                <% end %>
                <li>
                  <%= button_to destroy_user_session_path, method: :delete, class: "flex items-center gap-2 text-error" do %>
                    <%= icon("arrow-right-start-on-rectangle", size: "w-4 h-4") %>
                    Sign Out
                  <% end %>
                </li>
              </ul>
            </div>
          <% end %>
        </div>
      </nav>

      <main class="flex-1 p-4 md:p-6 lg:p-8">
        <div class="max-w-4xl mx-auto animate-slide-up">
          <%= yield %>
        </div>
      </main>
    <% end %>

    <%# Detect Mac and update keyboard shortcut hints %>
    <script>
      if (navigator.platform.includes('Mac')) {
        document.querySelectorAll('[data-hotkey-modifier]').forEach(el => {
          el.textContent = 'Cmd';
        });
      }
    </script>
  </body>
</html>
