# Codecov Setup Guide

This project uses [Codecov](https://codecov.io/) for test coverage reporting.

## What Was Implemented

1. **SimpleCov Integration**: Added SimpleCov gem for Ruby code coverage tracking
2. **Cobertura Format**: Coverage reports are generated in XML format for Codecov
3. **CI Integration**: GitHub Actions workflow uploads coverage after tests run
4. **Configuration**: codecov.yml file configures coverage thresholds and behavior

## Setup Instructions

### 1. Enable Codecov for the Repository

1. Go to [codecov.io](https://codecov.io/)
2. Sign in with your GitHub account
3. Add the `cgaray/townai` repository to Codecov
4. Codecov will provide a repository upload token

### 2. Configure GitHub Secrets

Add the Codecov token to GitHub repository secrets:

1. Go to repository Settings → Secrets and variables → Actions
2. Click "New repository secret"
3. Name: `CODECOV_TOKEN`
4. Value: Paste the token from Codecov
5. Click "Add secret"

### 3. Verify Coverage Upload

After configuring the token:

1. Push a commit or create a PR
2. GitHub Actions will run the test suite
3. Coverage will be automatically uploaded to Codecov
4. View coverage reports at `https://codecov.io/gh/cgaray/townai`

## Coverage Reports

### Local Development

When running tests locally, SimpleCov generates two formats:

- **HTML Report**: `coverage/index.html` - Open in browser for detailed coverage
- **XML Report**: `coverage/coverage.xml` - Cobertura format for Codecov

Run tests to generate coverage:

```bash
bin/rails test
```

View HTML coverage report:

```bash
open coverage/index.html  # macOS
xdg-open coverage/index.html  # Linux
```

### CI Coverage

In CI, only the XML format is generated and uploaded to Codecov. Coverage data from both the unit tests and system tests jobs are combined on Codecov.

## Coverage Configuration

The `codecov.yml` file configures:

- **Coverage targets**: Auto-adjust based on previous coverage
- **Status checks**: Pass/fail thresholds for PRs
- **Ignored paths**: Test files, config, vendor code excluded
- **PR comments**: Automatic coverage reports on pull requests

## Coverage Thresholds

Current configuration:

- **Project coverage**: Must stay within 1% of previous coverage
- **Patch coverage**: New code must be within 1% of target
- **Range**: 70-100% considered acceptable

To adjust thresholds, edit `codecov.yml` and update the `coverage.status` section.

## Troubleshooting

### Coverage not uploading

1. Verify `CODECOV_TOKEN` secret is set in GitHub
2. Check GitHub Actions logs for upload errors
3. Ensure coverage.xml file is generated before upload step

### Coverage seems incorrect

1. Check that SimpleCov is started before any application code loads
2. Verify test/test_helper.rb has SimpleCov at the top
3. Clear coverage directory: `rm -rf coverage/`
4. Re-run tests: `bin/rails test`

### HTML report not generated locally

HTML reports are only generated when `CI` environment variable is not set. When running tests locally, both HTML and XML are generated by default.

## Additional Resources

- [SimpleCov Documentation](https://github.com/simplecov-ruby/simplecov)
- [Codecov Documentation](https://docs.codecov.com/)
- [Codecov GitHub Action](https://github.com/codecov/codecov-action)
